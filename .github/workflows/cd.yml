name: CD-Mateo-Colina

on:
  workflow_run:
    workflows: ["CI-Mateo-Colina"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version variables
        id: version
        run: |
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "APP_VERSION=1.0.${{ github.run_number }}" >> $GITHUB_ENV

          echo "App Version: $APP_VERSION"
          echo "Commit: $COMMIT_SHA"
          echo "Build Number: $BUILD_NUMBER"

      - name: Trigger Render Deploy (with version info)
        id: trigger
        run: |
          echo "Deploying version: $APP_VERSION"
          echo "Commit SHA: $COMMIT_SHA"

          response=$(curl -s -X POST \
            -H "Accept: application/json" \
            ${{ secrets.RENDER_DEPLOY_HOOK }})

          echo "RESPONSE: $response"
          deploy_id=$(echo "$response" | jq -r '.deploy.id')
          echo "DEPLOY_ID=$deploy_id" >> $GITHUB_ENV

      - name: Wait for Render Deployment
        id: wait
        run: |
          echo "Checking deploy status for: $DEPLOY_ID"

          for i in {1..50}; do
            status=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys/$DEPLOY_ID" \
              | jq -r '.status')

            echo "Status: $status"

            # SUCCESS states
            if [[ "$status" == "live" ]]; then
              echo "Deployment successful!"
              exit 0
            fi

            # FAILURE states
            if [[ "$status" == "build_failed" || \
                  "$status" == "deploy_failed" || \
                  "$status" == "update_failed" || \
                  "$status" == "failed" || \
                  "$status" == "canceled" ]]; then
              echo "Render deployment failed with status: $status"
              exit 1
            fi

            sleep 10
          done

          echo "Timeout esperando despliegue"
          exit 1
